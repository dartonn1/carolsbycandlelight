<!DOCTYPE html>
<html lang="en">
<head>
  <div class="background">
  <meta charset="UTF-8">
  <title>Event Message</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="style.css" rel="stylesheet">
  
</head>
<body>
  
  <!-- VIEWER SCREEN -->
  <div id="viewer">
    <div id="snow-container">
        <div class="header">
    <h2 id="title">Welcome</h2>
    <p id="message">Please waitâ€¦</p>
    <p class="small" id="footer"></p>
    </div>
    </div>
  </div>
  <!-- CONTROLLER SCREEN -->
  <div id="controller" class="hidden">
    <h1>Site Controller</h1>
    <p class="small">Tap a button to update what guests see.</p>
    <div class="controls">
      <button onclick="setMessage('Arrival',
        'Please collect any goods from our stalls and head to your checkout area.')">
        Arrival
      </button>
      <button onclick="setMessage('Find Your Seats',
        'Please begin finding your seats. We will be starting shortly.')">
        Find Seats
      </button>
      <button onclick="setMessage('We Are Beginning',
        'Thank you for being here. Please settle in as we begin.')">
        About to Begin
      </button>
      <button onclick="setMessage('Prayer',
        'Be still, and know that I am God. - Psalm 46:10')">
        Prayer
      </button>
      <button onclick="setMessage('Thank You',
        'Thank you for being part of this gathering. May peace go with you.')">
        End
      </button>
    </div>
    </div>
  </div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* =====================
   CONFIG
===================== */
const SUPABASE_URL = "https://gmycaocgjaqwndcbdlmt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdteWNhb2NnamFxd25kY2JkbG10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTExMTcsImV4cCI6MjA4MTQ4NzExN30.WihrqGDXzkG1BVxBdZ4dYO2cQVbX-7gqDufetcouh4Y";
const CONTROL_CODE = "2707";

/* =====================
   CLIENT
===================== */
const db = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

/* =====================
   MODE
===================== */
const params = new URLSearchParams(window.location.search);
const isController = params.has("control");

const viewer = document.getElementById("viewer");
const controller = document.getElementById("controller");

if (isController) {
  const entered = prompt("Enter controller access code:");
  if (entered === CONTROL_CODE) {
    viewer.classList.add("hidden");
    controller.classList.remove("hidden");
  } else {
    alert("Access denied");
  }
}

/* =====================
   SOUND (viewer only)
===================== */
const chime = new Audio("chime.mp3");
chime.preload = "auto";

/* =====================
   CONTROLLER ACTION
===================== */
window.setMessage = async function(title, text) {
  const { error } = await db
    .from("event_state")
    .update({
      title: title,
      message: text,
      updated_at: new Date().toISOString()
    })
    .eq("id", 1);

  if (error) {
    alert("Failed to update");
    console.error(error);
  }
};

/* =====================
   UI UPDATE
===================== */
function updateUI(data, playSound = false) {
  document.getElementById("title").innerText = data.title;
  document.getElementById("message").innerText = data.message;
  document.getElementById("footer").innerText =
    "Updated at " + new Date(data.updated_at).toLocaleTimeString();

  if (playSound) {
    chime.currentTime = 0;
    chime.play().catch(() => {});
  }
}

/* =====================
   INITIAL LOAD
===================== */
async function loadInitial() {
  const { data } = await db
    .from("event_state")
    .select("*")
    .eq("id", 1)
    .single();

  if (data) updateUI(data);
}

loadInitial();

/* =====================
   REALTIME
===================== */
/* =====================
   AUTO REFRESH (POLLING)
===================== */
let lastUpdate = null;

async function pollForChanges() {
  const { data } = await db
    .from("event_state")
    .select("*")
    .eq("id", 1)
    .single();

  if (!data) return;

  if (lastUpdate !== data.updated_at) {
    updateUI(data, lastUpdate !== null);
    lastUpdate = data.updated_at;
  }
}

// start polling
setInterval(pollForChanges, 3000);
  .subscribe();
</script>
  
  <script src="script.js"></script>
</body>
</html>









